generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ─────────────────────────────────────────
// Enums
// ─────────────────────────────────────────

enum Role {
  TEAM_MEMBER   // 팀원
  TEAM_LEADER   // 팀장
  SECTION_CHIEF // 실장
  DEPT_HEAD     // 본부장
  HR_TEAM       // 인사팀
  CEO           // 대표이사
  SYSTEM_ADMIN  // 시스템 관리자
}

enum Level {
  L1
  L2
  L3
  L4
  L5
}

enum EmploymentType {
  REGULAR  // 정규직
  CONTRACT // 계약직
}

enum ConfirmationStatus {
  PENDING   // 미제출
  CONFIRMED // 확정
  DEFERRED  // 보류
}

// ─────────────────────────────────────────
// User — 직원 + 인증 통합 모델
// ─────────────────────────────────────────

/// 직원 정보와 NextAuth 인증 정보를 통합한 단일 모델.
/// 엑셀 업로드로 직원 데이터 적재, 이후 계정(email+password) 연결.
model User {
  id    String  @id @default(cuid())
  name  String  // 성명 (필수)

  // ── 인증 ──────────────────────────────
  email          String?   @unique
  emailVerified  DateTime?
  image          String?
  password       String?   // bcrypt 해시
  residentIdLast7 String?  // 주민번호 뒷 7자리 (본부장 계정 초기 비밀번호)

  // ── 인사 기본정보 ──────────────────────
  role           Role           @default(TEAM_MEMBER)
  department     String         @default("") // 본부
  team           String         @default("") // 팀
  level          Level?                       // 현재 직급 L1~L5
  position       String?                      // 직책 (팀원/팀장/실장/본부장 등)
  employmentType EmploymentType?              // 고용형태
  hireDate       DateTime?                    // 입사일자
  resignDate     DateTime?                    // 퇴사일자

  // ── 레벨업 관련 ────────────────────────
  /// 현재 레벨 체류 연수. 포인트/학점 연도 컬럼 개수 결정에 사용.
  yearsOfService  Int?
  /// "L3-07" 형식. level + yearsOfService 조합으로 표시되는 역량레벨.
  competencyLevel String?
  /// 레벨업 대상 연도 (예: 2025)
  levelUpYear     Int?
  /// 현재 레벨 시작일. 미설정 시 hireDate 기준으로 체류 연수 계산.
  levelStartDate  DateTime?
  /// 재직 여부 (레벨관리 화면 사용 Y/N 필터)
  isActive        Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ── Relations ─────────────────────────
  points             Point[]
  credits            Credit[]
  candidates         Candidate[]
  accounts           Account[]
  sessions           Session[]
  performanceGrades  PerformanceGrade[]
  bonusPenalties     BonusPenalty[]

  @@map("users")
}

// ─────────────────────────────────────────
// Phase 1 — 포인트 / 학점 / 업로드 이력
// ─────────────────────────────────────────

/// 연도별 업무성과 포인트.
/// 해당 레벨 체류 기간에 발생한 포인트만 기록.
/// cumulative = SUM(score) + SUM(merit) - SUM(penalty) (전체 레벨 체류 기간 기준)
model Point {
  id     String @id @default(cuid())
  userId String
  year   Int    // 포인트 발생 연도 (레벨 체류 기준, 예: 2023)

  score   Float @default(0) // 해당 연도 기본 점수
  merit   Float @default(0) // 해당 연도 발생 상점
  penalty Float @default(0) // 해당 연도 발생 벌점

  /// 누적값 = 해당 연도까지의 (Σscore + Σmerit - Σpenalty). DB 저장으로 조회 성능 확보.
  cumulative Float   @default(0)
  isMet      Boolean @default(false) // 상위 레벨 승격 기준 포인트 충족 여부

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year])
  @@map("points")
}

/// 연도별 교육이수 학점.
/// 2025년 기준으로 이전 연도에도 동일 기준 소급 적용.
model Credit {
  id     String @id @default(cuid())
  userId String
  year   Int    // 학점 적용 연도

  score      Float   @default(0) // 해당 연도 학점
  cumulative Float   @default(0) // 누적 학점 (해당 연도까지 Σscore)
  isMet      Boolean @default(false) // 상위 레벨 승격 기준 학점 충족 여부

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year])
  @@map("credits")
}

/// 엑셀 업로드 이력. 업로드 일시·파일명·건수·결과 추적.
model UploadHistory {
  id          String   @id @default(cuid())
  filename    String
  uploadedBy  String   // User.id
  recordCount Int      // 전체 행 수
  successCount Int     @default(0) // 성공 건수
  skipCount   Int      @default(0) // 스킵 건수 (중복 등)
  status      String   // success | failed | partial
  errorLog    String?  @db.Text // 오류 상세 (JSON 또는 텍스트)
  createdAt   DateTime @default(now())

  @@map("upload_histories")
}

// ─────────────────────────────────────────
// Phase 2 — 대상자 / 심사 / 본부장 의견
// ─────────────────────────────────────────

/// 레벨업 대상자.
/// 포인트 or 학점 충족 직원이 자동 생성되며, 인사팀이 심사대상 여부를 체크.
model Candidate {
  id     String @id @default(cuid())
  userId String
  year   Int    // 심사 대상 연도 (예: 2025)

  pointMet       Boolean  @default(false) // 포인트 충족 여부
  creditMet      Boolean  @default(false) // 학점 충족 여부
  isReviewTarget Boolean  @default(false) // 인사팀 심사대상 체크 여부
  /// "auto" = 자동 선정, "manual" = 수동 추가
  source         String   @default("manual")
  /// "normal" = 일반 승진, "special" = 특진 (체류 연수 미달)
  promotionType  String   @default("normal")
  /// null = 미저장(저장 버튼 활성), non-null = 저장됨 표시
  savedAt        DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  review       Review?
  confirmation Confirmation?

  @@unique([userId, year])
  @@map("candidates")
}

/// 심사 결과.
/// 역량레벨평가 + 본부장 의견 + 추천여부를 관리.
/// 추천 가능 조건: competencyScore + competencyEval + 소속본부장 의견 모두 입력 완료.
model Review {
  id          String @id @default(cuid())
  candidateId String @unique

  /// 역량점수 — 심사자가 입력하는 상위레벨 역량 기준표 평가 수치 (예: 3.0)
  competencyScore Float?
  /// 역량레벨평가 — 역량레벨 기준표를 대상자 기준으로 평가한 점수
  competencyEval  Float?
  /// 최종 추천 여부. null = 미결정, true = 추천, false = 제외(미추천)
  recommendation  Boolean?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  opinions  Opinion[]

  @@map("reviews")
}

/// 본부장 의견.
/// 소속본부장·타본부장·인사팀장이 각자 독립적으로 저장.
/// L4/L5 승진 시 타본부장 의견 필수.
model Opinion {
  id       String @id @default(cuid())
  reviewId String

  reviewerId   String  // 작성자 User.id
  /// 표시용 이름 (denormalized). 예: "경영지원본부장", "인사팀장"
  reviewerName String
  /// 작성자 역할 구분. "소속본부장" | "타본부장" | "인사팀장"
  reviewerRole String

  opinionText    String?  @db.Text // 의견 본문 (기입)
  /// null = 미선택, true = 추천, false = 미추천
  recommendation Boolean?
  /// null = 미저장(저장 버튼 활성), non-null = 저장됨
  savedAt        DateTime?
  /// 관리자가 수정한 경우 SYSTEM_ADMIN User.id
  modifiedBy     String?
  /// 관리자 수정 시각
  modifiedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  // 동일 심사에 동일 검토자가 중복 입력 불가
  @@unique([reviewId, reviewerId])
  @@map("opinions")
}

// ─────────────────────────────────────────
// 본부장 최종 제출
// ─────────────────────────────────────────

/// 본부장 최종 제출 이력.
/// 제출 시 SMTP 메일 발송, 이후 입력 잠금.
model Submission {
  id          String   @id @default(cuid())
  department  String   // 본부명
  year        Int      // 심사 연도
  submittedBy String   // User.id (제출한 본부장)
  submittedAt DateTime @default(now())

  @@unique([department, year])
  @@map("submissions")
}

// ─────────────────────────────────────────
// 연도별 평가등급
// ─────────────────────────────────────────

/// 직원 연도별 인사평가 등급 (S/A/B/C/D 등).
/// 엑셀 업로드 시 적재, 각 심사 화면에서 조회.
model PerformanceGrade {
  id     String @id @default(cuid())
  userId String
  year   Int    // 평가 연도 (예: 2021~2025)
  grade  String // 평가 등급 (S, A, B, C, D 등)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year])
  @@map("performance_grades")
}

// ─────────────────────────────────────────
// Phase 3 — 확정 / 기준 설정
// ─────────────────────────────────────────

/// 대표이사 최종 확정.
/// Candidate 1:1 관계. 확정/보류/미제출 상태 관리.
model Confirmation {
  id          String             @id @default(cuid())
  candidateId String             @unique

  status      ConfirmationStatus @default(PENDING) // 미제출 | 확정 | 보류
  confirmedBy String?  // 확정한 User.id (대표이사)
  confirmedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@map("confirmations")
}

/// 레벨별·연도별 승격 기준값.
/// 연도별로 기준을 달리 설정 가능 (@@unique [level, year]).
model LevelCriteria {
  id   String @id @default(cuid())
  level Level
  year  Int

  requiredPoints  Float // 승격 필요 누적 포인트
  requiredCredits Float // 승격 필요 누적 학점
  minTenure       Int   // 최소 체류 연수 (연차)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([level, year])
  @@map("level_criteria")
}

/// 등급별 포인트 기준.
/// 2022-2024 등급: S/A/B/C, 2025 등급: O/E/G/N/U
/// 포인트 자동 계산 시 직원의 연도별 평가등급 × 기준 포인트를 합산.
model GradeCriteria {
  id        String   @id @default(cuid())
  grade     String   // "S","A","B","C" (2022-2024) | "O","E","G","N","U" (2025)
  yearRange String   // "2022-2024" | "2025"
  points    Float    @default(0)

  updatedAt DateTime @updatedAt

  @@unique([grade, yearRange])
  @@map("grade_criteria")
}

/// 기준 변경 이력.
/// LevelCriteria 저장 시 변경된 필드마다 1행씩 기록.
model LevelCriteriaHistory {
  id            String   @id @default(cuid())
  level         Level
  year          Int

  changedById   String   // User.id
  changedByName String   // 표시용 이름 (denormalized)
  changedAt     DateTime @default(now())

  /// 변경된 필드명: "requiredPoints" | "requiredCredits" | "minTenure"
  field    String
  oldValue String?  // 기존값 (최초 등록 시 null)
  newValue String   // 변경값

  @@map("level_criteria_histories")
}

// ─────────────────────────────────────────
// 가감점 (BonusPenalty)
// ─────────────────────────────────────────

/// 개인별 가점/감점 항목.
/// 카테고리별 체크박스로 입력, 연도별 관리.
model BonusPenalty {
  id       String @id @default(cuid())
  userId   String
  year     Int

  /// "bonus" = 가점, "penalty" = 감점
  type     String
  /// 공로상 | B of B | 기술혁신상 | 견책 | 감급 | 정직 이상
  category String
  /// 가점: 1, 0.5, 0.5 / 감점: -0.5, -1, -2
  points   Float
  note     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("bonus_penalties")
}

// ─────────────────────────────────────────
// NextAuth.js v4 — Prisma Adapter 필수 모델
// ─────────────────────────────────────────

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}
