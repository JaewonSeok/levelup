/**
 * 엑셀 업로드 템플릿 생성 (서버 전용)
 */
import * as XLSX from "xlsx";

export function generateUploadTemplate(): Buffer {
  const wb = XLSX.utils.book_new();

  // ── 직원정보 시트 ──────────────────────────
  const gradeYears = [2022, 2023, 2024, 2025];

  const headers = [
    "본부",
    "팀",
    "이름",
    "직책",
    "레벨",
    "입사일자",
    "연차",
    "고용형태",
    "포인트",
    "학점",
    ...gradeYears.map((y) => `${y}평가등급`),
  ];

  const example1 = [
    "경영지원본부",
    "인사팀",
    "홍길동",
    "팀원",
    "L3",
    "2022-03-01",
    5,
    "정규직",
    12.5,
    8.0,
    "A", "B", "S", "A",
  ];
  const example2 = [
    "기술지원본부",
    "개발팀",
    "김철수",
    "팀장",
    "L4",
    "2021-08-15",
    7,
    "정규직",
    20.0,
    15.0,
    "S", "A", "S", "A",
  ];

  const ws = XLSX.utils.aoa_to_sheet([headers, example1, example2]);

  // 컬럼 너비 설정
  ws["!cols"] = [
    { wch: 14 }, // 본부
    { wch: 12 }, // 팀
    { wch: 8 },  // 이름
    { wch: 8 },  // 직책
    { wch: 8 },  // 레벨
    { wch: 14 }, // 입사일자
    { wch: 6 },  // 연차
    { wch: 10 }, // 고용형태
    { wch: 8 },  // 포인트
    { wch: 8 },  // 학점
    ...gradeYears.map(() => ({ wch: 12 })), // 20xx평가등급
  ];

  XLSX.utils.book_append_sheet(wb, ws, "직원정보");

  // ── 작성안내 시트 ──────────────────────────
  const guide = [
    ["필드명", "필수여부", "허용값 / 형식", "예시"],
    ["본부", "필수", "소속 본부명 (문자열)", "경영지원본부"],
    ["팀", "필수", "소속 팀명 (문자열)", "인사팀"],
    ["이름", "필수", "직원 성명 (문자열)", "홍길동"],
    ["직책", "선택", "팀원 / 팀장 / 실장 / 본부장 등", "팀원"],
    ["레벨", "필수", "L1 / L2 / L3 / L4 / L5", "L3"],
    ["입사일자", "필수", "YYYY-MM-DD (예: 2022-03-01)", "2022-03-01"],
    ["연차", "필수", "현재 레벨 체류 연수 (0 이상 정수)", "5"],
    ["고용형태", "필수", "정규직 또는 계약직", "정규직"],
    ["포인트", "선택", "해당 연도 포인트 점수 (소수 가능)", "12.5"],
    ["학점", "선택", "해당 연도 학점 점수 (소수 가능)", "8.0"],
    ...gradeYears.map((y) => [
      `${y}평가등급`,
      "선택",
      y <= 2024 ? "S / A / B / C" : "S / O / E / G / N / U",
      y <= 2024 ? "A" : "O",
    ]),
    [],
    ["※ 주의사항"],
    ["- 다중 시트 지원: 시트별로 본부/팀 구분 가능"],
    ["- 빈 행은 자동으로 건너뜁니다"],
    ["- 중복 사원(이름+입사일 동일)은 업로드 시 업데이트 또는 스킵 선택 가능"],
  ];

  const wsGuide = XLSX.utils.aoa_to_sheet(guide);
  wsGuide["!cols"] = [
    { wch: 12 },
    { wch: 8 },
    { wch: 36 },
    { wch: 14 },
  ];

  XLSX.utils.book_append_sheet(wb, wsGuide, "작성안내");

  return XLSX.write(wb, { type: "buffer", bookType: "xlsx" }) as Buffer;
}
