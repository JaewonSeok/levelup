/**
 * 엑셀 업로드 템플릿 생성 (서버 전용)
 */
import * as XLSX from "xlsx";

export function generateUploadTemplate(): Buffer {
  const wb = XLSX.utils.book_new();

  // ── 직원정보 시트 ──────────────────────────
  // 헤더 순서: 본부, 팀, 이름, 직책, 레벨, 입사일자, 연차, 2021~2025평가등급, 학점
  const gradeYears = [2021, 2022, 2023, 2024, 2025];

  const headers = [
    "본부",
    "팀",
    "이름",
    "직책",
    "레벨",
    "입사일자",
    "연차",
    ...gradeYears.map((y) => `${y}평가등급`),
    "학점",
  ];

  const example1 = [
    "경영지원본부",
    "인사팀",
    "홍길동",
    "팀원",
    "L3",
    "2022-03-01",
    5,
    "",   // 2021평가등급 (입사 전이므로 공백)
    "A",  // 2022평가등급
    "B",  // 2023평가등급
    "S",  // 2024평가등급
    "E",  // 2025평가등급
    8.0,  // 학점
  ];
  const example2 = [
    "기술지원본부",
    "개발팀",
    "김철수",
    "팀장",
    "L4",
    "2021-08-15",
    7,
    "A",  // 2021평가등급
    "S",  // 2022평가등급
    "A",  // 2023평가등급
    "S",  // 2024평가등급
    "O",  // 2025평가등급
    15.0, // 학점
  ];

  const ws = XLSX.utils.aoa_to_sheet([headers, example1, example2]);

  // 컬럼 너비 설정
  ws["!cols"] = [
    { wch: 14 }, // 본부
    { wch: 12 }, // 팀
    { wch: 8 },  // 이름
    { wch: 8 },  // 직책
    { wch: 8 },  // 레벨
    { wch: 14 }, // 입사일자
    { wch: 6 },  // 연차
    ...gradeYears.map(() => ({ wch: 12 })), // 20xx평가등급
    { wch: 8 },  // 학점
  ];

  XLSX.utils.book_append_sheet(wb, ws, "직원정보");

  // ── 작성안내 시트 ──────────────────────────
  const guide = [
    ["필드명", "필수여부", "허용값 / 형식", "예시"],
    ["본부", "필수", "소속 본부명 (문자열)", "경영지원본부"],
    ["팀", "필수", "소속 팀명 (문자열)", "인사팀"],
    ["이름", "필수", "직원 성명 (문자열)", "홍길동"],
    ["직책", "선택", "팀원 / 팀장 / 실장 / 본부장 등", "팀원"],
    ["레벨", "필수", "L0 / L1 / L2 / L3 / L4 / L5", "L3"],
    ["입사일자", "필수", "YYYY-MM-DD (예: 2022-03-01)", "2022-03-01"],
    ["연차", "필수", "현재 레벨 체류 연수 (0 이상 정수)", "5"],
    ...gradeYears.map((y) => [
      `${y}평가등급`,
      "선택",
      y <= 2024 ? "S / A / B / C (입사 전 연도는 공백)" : "S / O / E / G / N / U",
      y <= 2024 ? "A" : "O",
    ]),
    ["학점", "선택", "해당 연도까지 누적 학점 점수 (소수 가능)", "8.0"],
    [],
    ["※ 주의사항"],
    ["- 다중 시트 지원: 시트별로 본부/팀 구분 가능"],
    ["- 빈 행은 자동으로 건너뜁니다"],
    ["- 중복 사원(이름+입사일 동일)은 업로드 시 업데이트 또는 스킵 선택 가능"],
    ["- 입사 전 연도의 평가등급은 공백으로 두세요 (자동 무시)"],
  ];

  const wsGuide = XLSX.utils.aoa_to_sheet(guide);
  wsGuide["!cols"] = [
    { wch: 12 },
    { wch: 8 },
    { wch: 40 },
    { wch: 14 },
  ];

  XLSX.utils.book_append_sheet(wb, wsGuide, "작성안내");

  return XLSX.write(wb, { type: "buffer", bookType: "xlsx" }) as Buffer;
}
